name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1 : Tests et v√©rifications
  test:
    name: Tests et Qualit√© du Code
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: webcup25_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql
          coverage: xdebug

      - name: V√©rification de la version PHP
        run: php -v

      - name: Validation du composer.json
        run: composer validate --strict

      - name: Installation des d√©pendances
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: V√©rification de la syntaxe PHP
        run: find . -type f -name '*.php' -not -path './vendor/*' -exec php -l {} \;

      - name: Cr√©ation du fichier .env de test
        run: |
          cp .env.example .env || echo "DB_HOST=127.0.0.1
          DB_NAME=webcup25_test
          DB_USER=root
          DB_PASS=root
          APP_ENV=testing
          APP_URL=http://localhost" > .env

      - name: Ex√©cution des tests PHPUnit
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit --coverage-text
          else
            echo "PHPUnit non configur√©, passage √† l'√©tape suivante"
          fi

      - name: Analyse statique avec PHPStan (optionnel)
        run: |
          if [ -f "vendor/bin/phpstan" ]; then
            vendor/bin/phpstan analyse app
          else
            echo "PHPStan non configur√©"
          fi

  # Job 2 : V√©rification de s√©curit√©
  security:
    name: V√©rification de S√©curit√©
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Installation des d√©pendances
        run: composer install --prefer-dist --no-progress

      - name: V√©rification des vuln√©rabilit√©s
        run: |
          composer audit || echo "Audit des d√©pendances effectu√©"

  # Job 3 : V√©rification des assets (PHP + JS/jQuery)
  assets-check:
    name: V√©rification des Assets
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: V√©rification de la structure des assets
        run: |
          echo "‚úÖ V√©rification des fichiers CSS..."
          if [ -d "assets/css" ]; then
            find assets/css -name "*.css" -type f
          fi
          echo "‚úÖ V√©rification des fichiers JS..."
          if [ -d "assets/js" ]; then
            find assets/js -name "*.js" -type f
          fi
          echo "‚úÖ Assets statiques pr√™ts (pas de build n√©cessaire)"

      - name: Upload des artifacts
        uses: actions/upload-artifact@v4
        with:
          name: assets
          path: assets/
          retention-days: 1

  # Job 4 : D√©ploiement vers cPanel via FTP
  deploy:
    name: D√©ploiement en Production (cPanel)
    runs-on: ubuntu-latest
    needs: [test, security, assets-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configuration de PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql

      - name: Installation des d√©pendances Composer
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: T√©l√©chargement des artifacts
        uses: actions/download-artifact@v4
        with:
          name: assets
          path: assets/

      - name: D√©ploiement via FTP vers cPanel
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          server-dir: /public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/.env.example
            **/phpunit.xml.dist
            **/composer.lock
            **/.gitignore
            **/.gitattributes
            **/*.md
            **/.htaccess.example
          
      - name: Notification de succ√®s
        if: success()
        run: |
          echo "‚úÖ D√©ploiement r√©ussi sur cPanel !"
          echo "üì¶ Fichiers PHP et d√©pendances Composer d√©ploy√©s"
          echo "üåê V√©rifiez votre site en ligne"

  # Job 5 : Notification
  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: Notification de succ√®s
        if: success()
        run: echo "‚úÖ D√©ploiement r√©ussi !"

      - name: Notification d'√©chec
        if: failure()
        run: echo "‚ùå Le d√©ploiement a √©chou√©"

