name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1 : Tests et vÃ©rifications
  test:
    name: Tests et QualitÃ© du Code
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: webcup25_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql
          coverage: xdebug

      - name: VÃ©rification de la version PHP
        run: php -v

      - name: Validation du composer.json
        run: composer validate --strict

      - name: Installation des dÃ©pendances
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: VÃ©rification de la syntaxe PHP
        run: find . -type f -name '*.php' -not -path './vendor/*' -exec php -l {} \;

      - name: CrÃ©ation du fichier .env de test
        run: |
          cp .env.example .env || echo "DB_HOST=127.0.0.1
          DB_NAME=webcup25_test
          DB_USER=root
          DB_PASS=root
          APP_ENV=testing
          APP_URL=http://localhost" > .env

      - name: ExÃ©cution des tests PHPUnit
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit --coverage-text
          else
            echo "PHPUnit non configurÃ©, passage Ã  l'Ã©tape suivante"
          fi

      - name: Analyse statique avec PHPStan (optionnel)
        run: |
          if [ -f "vendor/bin/phpstan" ]; then
            vendor/bin/phpstan analyse app
          else
            echo "PHPStan non configurÃ©"
          fi

  # Job 2 : VÃ©rification de sÃ©curitÃ©
  security:
    name: VÃ©rification de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Installation des dÃ©pendances
        run: composer install --prefer-dist --no-progress

      - name: VÃ©rification des vulnÃ©rabilitÃ©s
        run: |
          composer audit || echo "Audit des dÃ©pendances effectuÃ©"

  # Job 3 : VÃ©rification des assets (PHP + JS/jQuery)
  assets-check:
    name: VÃ©rification des Assets
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: VÃ©rification de la structure des assets
        run: |
          echo "âœ… VÃ©rification des fichiers CSS..."
          if [ -d "assets/css" ]; then
            find assets/css -name "*.css" -type f
          fi
          echo "âœ… VÃ©rification des fichiers JS..."
          if [ -d "assets/js" ]; then
            find assets/js -name "*.js" -type f
          fi
          echo "âœ… Assets statiques prÃªts (pas de build nÃ©cessaire)"

      - name: Upload des artifacts
        uses: actions/upload-artifact@v4
        with:
          name: assets
          path: assets/
          retention-days: 1

  # Job 4 : DÃ©ploiement vers cPanel via FTP
  deploy:
    name: DÃ©ploiement en Production (cPanel)
    runs-on: ubuntu-latest
    needs: [test, security, assets-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configuration de PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql

      - name: Installation des dÃ©pendances Composer
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: TÃ©lÃ©chargement des artifacts
        uses: actions/download-artifact@v4
        with:
          name: assets
          path: assets/

      - name: CrÃ©ation du fichier .env pour la production
        run: |
          echo "ðŸ”§ CrÃ©ation du fichier .env depuis GitHub Secrets..."
          cat > .env << EOF
          # ===========================================
          # ENVIRONNEMENT - PRODUCTION
          # ===========================================
          APP_ENV=production
          
          # ===========================================
          # BASE DE DONNÃ‰ES - DÃ‰VELOPPEMENT
          # ===========================================
          DB_DEV_HOST=localhost
          DB_DEV_NAME=webcup25
          DB_DEV_USER=root
          DB_DEV_PASS=
          
          # ===========================================
          # BASE DE DONNÃ‰ES - PRODUCTION
          # ===========================================
          DB_PROD_HOST=${{ secrets.DB_PROD_HOST }}
          DB_PROD_NAME=${{ secrets.DB_PROD_NAME }}
          DB_PROD_USER=${{ secrets.DB_PROD_USER }}
          DB_PROD_PASS=${{ secrets.DB_PROD_PASS }}
          
          # ===========================================
          # APPLICATION
          # ===========================================
          APP_URL=${{ secrets.APP_URL }}
          
          # ===========================================
          # AUTRES
          # ===========================================
          IA_API_KEY=${{ secrets.IA_API_KEY }}
          UPLOAD_PATH=storage/avatars/
          EOF
          echo "âœ… Fichier .env crÃ©Ã© avec succÃ¨s"
          echo "ðŸ“‹ Variables configurÃ©es depuis GitHub Secrets"

      - name: DÃ©ploiement via FTP vers cPanel
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          server-dir: /public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/phpunit.xml.dist
            **/composer.lock
            **/.gitignore
            **/.gitattributes
            **/*.md
            **/.htaccess.example
            **/switch-env.php
            **/create-env.*
            **/test-db.php
          
      - name: Notification de succÃ¨s
        if: success()
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi sur cPanel !"
          echo "ðŸ“¦ Fichiers PHP et dÃ©pendances Composer dÃ©ployÃ©s"
          echo "ðŸ” Fichier .env crÃ©Ã© automatiquement depuis GitHub Secrets"
          echo "ðŸŒ VÃ©rifiez votre site en ligne"

  # Job 5 : Notification
  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: Notification de succÃ¨s
        if: success()
        run: echo "âœ… DÃ©ploiement rÃ©ussi !"

      - name: Notification d'Ã©chec
        if: failure()
        run: echo "âŒ Le dÃ©ploiement a Ã©chouÃ©"

